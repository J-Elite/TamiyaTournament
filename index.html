<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TAMIYA MANIA TOURNAMENT</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@700&display=swap" rel="stylesheet" />
<style>
  body {
    margin: 0; padding: 50px 200px 100px 200px;
    font-family: 'Aptos', sans-serif;
    text-align: center;
    color: white;
    background-image: url('BG.jpg');
    background-position: center center;
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
  }
  /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Kanit */
  :lang(th), body:lang(th), *:lang(th) {
    font-family: 'Kanit', sans-serif;
  }

  h1, h2, .btn, .btn-next-round, .btn-confirm {
    font-family: inherit;
  }
  h1 {
    margin-top: 1rem; margin-bottom: 1rem;
    display: flex; align-items: center; justify-content: center; gap: 0;
  }
  h1 .side-logo:first-child {
    margin-right: 30px;
    width: 1000px;
    height: auto;
    position: relative;
    top: 50px;
  }
  h1 .side-logo:last-child {
    margin-left: 30px;
    width: 1000px;
    height: auto;
    position: relative;
    top: 40px;
  }
  h1 .title-image {
    max-width: 1400px; width: 100%; height: auto;
    user-select: none; pointer-events: none;
  }
  h2 {
    font-size: 6rem; font-weight: bold; color: white;
    margin: 0rem 0 3rem;
  }
  .btn, .btn-next-round, .btn-confirm {
    font-family: 'Aptos', sans-serif;
    font-weight: 800;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    user-select: none;
    transition: 0.3s ease;
  }
  .btn {
    background: #ff0000;
    color: white;
    padding: 0.8rem 2.2rem;
    font-size: 4rem;
    margin-bottom: 4rem;
  }
  .btn:hover { background: #cc0000; }
  .btn-next-round {
    background-color: #ff8c00;
    color: white;
    font-size: 4rem;
    padding: 0.7rem 2rem;
    margin-bottom: 4rem;
    display: none;
  }
  .btn-next-round:hover { background-color: #cc7000; }
  .btn-confirm {
    background-color: #00aa00;
    color: white;
    font-size: 5.4rem;
    padding: 1.2rem 4.5rem;
    margin-top: 1.5rem;
  }
  .btn-confirm:hover:enabled { background-color: #008800; }
  .main-wrapper {
    width: 100%;
    max-width: 5000px;
    margin: 0 auto;
    padding: 0 3rem;
  }
  .rounds-grid {
    display: flex;
    gap: 25rem;
    justify-content: center;
    flex-wrap: nowrap;
    flex-direction: row;
  }
  .column {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }
  .round-block {
    display: flex;
    align-items: center;
    gap: 10rem;
    justify-content: center;
    cursor: pointer;
  }
  .round-block.selected {
    background: rgba(0,255,0,0.2);
    border-radius: 10px;
  }
  .round-block .round-label-number {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .round-block .round-label {
    font-size: 4rem;
    font-weight: 500;
    color: #ffffff;
    user-select: none;
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  .round-block .round-number {
    font-size: 4rem;
    font-weight: 500;
    color: white;
    user-select: none;
    min-width: 28px;
    text-align: left;
  }
  .round-label-number {
    width: 100px;
    display: flex;
    justify-content: flex-end;
    gap: 2.5rem;
    color: #ff0000;
    font-size: 2.4rem;
    font-weight: 300;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .car-list {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    min-width: 220px;
    width: 300px; /* fix width to keep alignment consistent */
  }
  /* ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ 2 ‡πÄ‡∏•‡∏ô */
  .round-block[data-lanes="2"] .car-list {
    justify-content: center; /* ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
  }
  .car-id {
    min-width: 120px;
    min-height: 120px;
    background-color: white;
    border: 7px solid #0051ba;
    border-radius: 10px;
    color: black;
    font-size: 4rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    cursor: default;
    position: relative;
  }
 .car-id.selected {
  background-color: #00ff00; /* ‡∏ñ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  color: rgb(0, 0, 0);              /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
  border-color: #00ff00;     /* ‡∏Ç‡∏≠‡∏ö‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ) */
  box-shadow: none;          /* ‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
}

.popup {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.popup-content {
    background: #111;
    border: 3px solid #ff0000; /* 2px ‚Üí 3px (2*1.5=3) */
    border-radius: 24px; /* 16px ‚Üí 24px */
    padding: 0rem 5rem 5rem 5rem; /* 3rem 4rem ‚Üí *1.5 */
    text-align: center;
    width: 1350px; /* 900px * 1.5 */
    height: 2000px; /* 900px * 1.5 */
    width: 60%;
    color: white;
    position: relative;
    user-select: none;
}

.popup-content h3 {
    font-size: 10rem; /* 4rem * 1.5 */
    color: #ff0000;
    margin-bottom: 4.5rem; /* 3rem * 1.5 */
}

.lanes-labels {
    display: flex;
    justify-content: center;
    gap: 4.5rem; /* 3rem * 1.5 */
    margin-bottom: 1.5rem; /* 1rem * 1.5 */
    font-size: 9rem; /* 2.4rem * 1.5 */
    font-weight: 900;
    color: #ffffff;
}

.lanes-labels > div {
    flex: 0 0 800px; /* 250px * 1.5 */
    display: flex;
    justify-content: center;
    align-items: center;
}

.competitors {
    display: flex;
    justify-content: center;
    gap: 6rem; /* 3rem * 1.5 */
    min-height: 700px; /* 320px * 1.5 */
}

.competitor {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    border: 4.5px solid transparent; /* 3px * 1.5 */
    border-radius: 21px; /* 14px * 1.5 */
    padding: 1.2rem; /* 0.5rem * 1.5 */
    min-width: 600px; /* 250px * 1.5 */
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.competitor.selected {
    border-color: #00ff00;
    box-shadow: 0 0 22.5px #00ff00; /* 15px * 1.5 */
    position: relative;
    z-index: 2;
}

.selected-wrapper::before {
    content: none !important;
}

.selected-wrapper {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 4.5rem; /* 3rem * 1.5 */
    margin-bottom: 1.5rem; /* 1rem * 1.5 */
    border: none;
    box-shadow: none;
}

.competitor img {
    width: 750px; /* 250px * 1.5 */
    height: 750px; /* 250px * 1.5 */
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 3rem; /* 0.8rem * 1.5 */
    border: 3px solid #ffffff; /* 2px * 1.5 */
    background: #333;
}

.competitor.no-photo img {
    border: 3px solid #888; /* 2px * 1.5 */
    background: #222;
}

.competitor .name {
    font-size: 7rem; /* 1.8rem * 1.5 */
    margin-bottom: 2rem; /* 1.2rem * 1.5 */
    color: white;
}

.competitor .car-number {
    font-size: 12rem; /* 2.4rem * 1.5 */
    font-weight: 500;
    color: rgb(255, 255, 255);
    padding: 0.9rem 2rem; /* 0.3rem 0.6rem * 1.5 */
    border-radius: 18px; /* 12px * 1.5 */
    min-width: 78px; /* 52px * 1.5 */
    text-align: center;
}

#loadingPopup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.loading-spinner {
    width: 120px; /* 80px * 1.5 */
    height: 120px; /* 80px * 1.5 */
    border-radius: 50%;
    border: 13.5px solid white; /* 9px * 1.5 */
    border-top: 13.5px solid #ff0000;
    animation: spin 1s linear infinite;
}

  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }
</style>
</head>
<body>
  <h1>
    <img src="MagnumSaber.png" alt="MagnumSaber" class="side-logo" />
    <img src="Tamiya Mania.png" alt="TAMIYA MANIA" class="title-image" />
    <img src="SonicSaber.png" alt="SonicSaber" class="side-logo" />
  </h1>
  <h2 id="roundTitle">QUALIFICATION ROUND</h2>
  <button class="btn" id="startBtn">LET'S &amp; GO !</button>
  <button class="btn-next-round" id="btnNextRound" style="display:none;">NEXT ROUND</button>
  <div class="main-wrapper">
    <div class="rounds-grid" id="roundsWrapper"></div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡πà‡∏° -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <h3 id="popupTitle">ROUND <span class="round-number-popup">1</span></h3>
      <div class="lanes-labels" id="lanesLabels">
        <div>LANE 1</div>
        <div>LANE 2</div>
        <div>LANE 3</div>
      </div>
      <div class="competitors" id="competitorsContainer"></div>
    </div>
  </div>

  <!-- Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö -->
  <div id="popupSelect" class="popup" style="display:none;">
    <div class="popup-content">
      <button id="closePopupSelectBtn" style="position:absolute;top:1rem;right:1rem;font-size:6rem;color:#fff;background:none;border:none;cursor:pointer;">√ó</button>
      <h3 id="popupSelectTitle">ROUND <span id="selectRoundNumber">1</span></h3>
      <div class="lanes-labels"><div>LANE 1</div><div>LANE 2</div><div>LANE 3</div></div>
      <div class="selected-wrapper"><div class="competitors" id="competitorsSelectContainer"></div></div>
      <button id="confirmSelectBtn" class="btn-confirm" disabled>CONFIRM</button>
    </div>
  </div>

  <div id="loadingPopup"><div class="loading-spinner"></div></div>

<script>
const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxX4t2uqvN9-YR4LPMcTO9e1bYldLSarP2WoXbuHXBFvqh_8yMuwVAPt-MS3I33qDA-/exec';

const loadingPopup = document.getElementById('loadingPopup');
const popup = document.getElementById('popup');
const popupTitle = document.getElementById('popupTitle');
const competitorsContainer = document.getElementById('competitorsContainer');
const startBtn = document.getElementById('startBtn');
const roundTitle = document.getElementById('roundTitle');
const popupSelect = document.getElementById('popupSelect');
const closePopupSelectBtn = document.getElementById('closePopupSelectBtn');
const selectRoundNumber = document.getElementById('selectRoundNumber');
const competitorsSelectContainer = document.getElementById('competitorsSelectContainer');
const confirmSelectBtn = document.getElementById('confirmSelectBtn');
const btnNextRound = document.getElementById('btnNextRound');
const roundsWrapper = document.getElementById('roundsWrapper');
const lanesLabels = document.getElementById('lanesLabels');

let allParticipants = [];
let roundsData = [];
let currentRoundIndex = 0;
let selectingRoundIndex = null;
let selectedCompetitorsSet = new Set();

function showLoading(show) {
  loadingPopup.style.display = show ? 'flex' : 'none';
}

async function loadParticipants() {
  showLoading(true);
  try {
    const res = await fetch(GOOGLE_SHEET_API_URL);
    const data = await res.json();
    return data.map(p => ({
  id: p.id,
  owner: p.owner,
  nickname: (p.nickname && p.nickname.trim() !== '') ? p.nickname.trim() : '-',
  image: p.image || `https://i.pravatar.cc/250?u=${p.id}`
}));

  } catch (e) {
    alert('Fetch error: ' + e.message);
    return [];
  } finally {
    showLoading(false);
  }
}

function delay(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

function createEmptyCompetitorDiv(){
  const div = document.createElement('div');
  div.className = 'competitor no-photo';
  div.innerHTML = `
    <img src="" alt="" />
    <div class="name">&nbsp;</div>
    <div class="car-number">&nbsp;</div>
  `;
  return div;
}

async function shuffleAnimation(laneIndex, containerDiv, pool) {
  for(let i=0; i<15; i++){
    const p = pool[Math.floor(Math.random()*pool.length)];
    containerDiv.querySelector('img').src = p.image;
    containerDiv.querySelector('.name').textContent = p.nickname;
    containerDiv.querySelector('.car-number').textContent = p.id;
    await delay(0);
  }
}

function groupCars(pool) {
  let groups = [];
  let temp = [...pool];

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 6 ‡∏Ñ‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏£‡∏≠‡∏ö ‡∏£‡∏≠‡∏ö‡∏•‡∏∞ 2 ‡∏Ñ‡∏±‡∏ô
  if (temp.length === 6) {
  while (temp.length > 0) {
    let pair = [];
    let ownersInPair = new Set();

    for (let i = 0; i < temp.length; i++) {
      if (pair.length === 2) break;
      if (!ownersInPair.has(temp[i].owner)) {
        pair.push(temp[i]);
        ownersInPair.add(temp[i].owner);
      }
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö 2 ‡∏Ñ‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å temp
    if (pair.length === 2) {
      for (let p of pair) {
        let idx = temp.findIndex(x => x.id === p.id);
        if (idx > -1) temp.splice(idx, 1);
      }
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà owner ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡∏¢
      pair = temp.splice(0, 2);
    }

    groups.push(pair);
  }
  return groups;
}


  while (temp.length > 0) {
    let round = [];
    let ownersInRound = new Set();

    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (3 ‡∏´‡∏£‡∏∑‡∏≠ 2 ‡∏´‡∏£‡∏∑‡∏≠ 1)
    let targetCount = Math.min(temp.length, 3);

    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    if (temp.length === 1 && groups.length > 0) {
      let lastGroup = groups.pop();

      if (lastGroup.length === 3) {
        // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å 2 ‡∏Ñ‡∏±‡∏ô
        let movedCar = lastGroup.pop();
        groups.push(lastGroup);

        // ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏ñ 1 ‡∏Ñ‡∏±‡∏ô‡∏à‡∏≤‡∏Å temp + movedCar
        groups.push([temp.shift(), movedCar]);
        continue; // ‡∏ó‡∏≥‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ
      } else {
        // ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏Ñ‡∏±‡∏ô ‡∏Å‡πá‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        lastGroup.push(temp.shift());
        groups.push(lastGroup);
        continue;
      }
    }

    // ‡∏•‡∏π‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà owner ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏° targetCount
    for (let i = temp.length - 1; i >= 0; i--) {
      let p = temp[i];
      if (!ownersInRound.has(p.owner)) {
        round.push(p);
        ownersInRound.add(p.owner);
        temp.splice(i, 1);
      }
      if (round.length === targetCount) break;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏≠‡∏ö (owner ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î) ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà owner ‡∏ã‡πâ‡∏≥ (‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    if (round.length < targetCount && temp.length > 0) {
      for (let i = temp.length - 1; i >= 0; i--) {
        if (round.length === targetCount) break;
        round.push(temp[i]);
        temp.splice(i, 1);
      }
    }

    groups.push(round);
  }

  return groups;
}


async function runAllRoundsShuffle() {
  roundsData = [];
  currentRoundIndex = 0;
  roundsWrapper.innerHTML = '';
  startBtn.style.display = 'none';
  roundTitle.textContent = 'QUALIFICATION ROUND';
  let pool = [...allParticipants];
  popup.style.display = 'flex';

  const groupedRounds = groupCars(pool);
  const roundsCount = groupedRounds.length;

  for(let round=1; round<=roundsCount; round++){
    popupTitle.innerHTML = `ROUND <span class="round-number-popup">${round}</span>`;
    competitorsContainer.innerHTML = '';
    const currentGroup = groupedRounds[round - 1];

    const laneDivs = lanesLabels.children;
    for(let i=0; i<3; i++){
      laneDivs[i].style.display = i < currentGroup.length ? 'flex' : 'none';
    }

    for(let lane=0; lane<currentGroup.length; lane++){
      competitorsContainer.appendChild(createEmptyCompetitorDiv());
    }

    const winners = [];
    for(let lane=0; lane<currentGroup.length; lane++){
      const containerDiv = competitorsContainer.children[lane];
      await shuffleAnimation(lane, containerDiv, currentGroup);
      const winner = currentGroup[lane];
      winners.push(winner);
      containerDiv.querySelector('img').src = winner.image;
      containerDiv.querySelector('.name').textContent = winner.nickname;
      containerDiv.querySelector('.car-number').textContent = winner.id;
      await delay(400);
    }
    roundsData.push({round, winners, passedIds: new Set()});
    addRoundResult(round, winners);
    await delay(1000);
  }
  popup.style.display = 'none';
  roundTitle.textContent = "LET'S & GO INTO THE NEXT ROUND !";
  roundsWrapper.querySelectorAll('.round-block').forEach((block, i) => {
    block.addEventListener('click', () => openSelectPopup(i));
  });
}

function addRoundResult(roundNum, competitors) {
  const roundsPerColumn = 10;
  let columnIndex = Math.floor((roundNum - 1) / roundsPerColumn);
  let columnDiv = roundsWrapper.children[columnIndex];
  if (!columnDiv) {
    columnDiv = document.createElement('div');
    columnDiv.className = 'column';
    roundsWrapper.appendChild(columnDiv);
  }
  const roundBlock = document.createElement('div');
  roundBlock.className = 'round-block';
  roundBlock.dataset.roundIndex = roundNum - 1;
  roundBlock.dataset.lanes = competitors.length;

  let carListHtml = '';
  for(let i=0; i<competitors.length; i++){
    carListHtml += `<div class="car-id">${competitors[i].id}</div>`;
  }
  roundBlock.innerHTML = `
    <div class="round-label-number">
      <div class="round-label">ROUND</div>
      <div class="round-number">${roundNum}</div>
    </div>
    <div class="car-list">
      ${carListHtml}
    </div>
  `;
  columnDiv.appendChild(roundBlock);
}

function openSelectPopup(roundIndex) {
  selectingRoundIndex = roundIndex;
  selectRoundNumber.textContent = roundsData[roundIndex].round;
  popupSelect.style.display = 'flex';
  confirmSelectBtn.disabled = true;
  selectedCompetitorsSet.clear();

  competitorsSelectContainer.innerHTML = '';
  const winners = roundsData[roundIndex].winners;

  const lanesLabelsSelect = popupSelect.querySelector('.lanes-labels');
  const laneDivs = lanesLabelsSelect.children;
  for(let i=0; i<3; i++){
    laneDivs[i].style.display = i < winners.length ? 'flex' : 'none';
  }

  winners.forEach((competitor, idx) => {
    const div = document.createElement('div');
    div.className = 'competitor';
    div.dataset.id = competitor.id;
    div.innerHTML = `
      <img src="${competitor.image}" alt="${competitor.nickname}" />
      <div class="name">${competitor.nickname}</div>
      <div class="car-number">${competitor.id}</div>
    `;
    div.addEventListener('click', () => {
      if(div.classList.contains('selected')){
        div.classList.remove('selected');
        selectedCompetitorsSet.delete(competitor.id.toString());
      } else {
        const maxSelect = winners.length === 3 ? 2 : 1;
        if(selectedCompetitorsSet.size >= maxSelect) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô
        selectedCompetitorsSet.add(competitor.id.toString());
        div.classList.add('selected');
      }
      updateConfirmButton(winners.length);
    });

    competitorsSelectContainer.appendChild(div);
  });
}

function updateConfirmButton(totalCompetitors){
  let minSelect = 1;
  let maxSelect = 1;
  if(totalCompetitors === 3) {
    minSelect = 1;  // **‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ**
    maxSelect = 2;
  } else if(totalCompetitors === 2) {
    minSelect = 1;
    maxSelect = 1;
  } else {
    minSelect = 1;
    maxSelect = 1;
  }

  // confirm ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á minSelect ‡∏ñ‡∏∂‡∏á maxSelect
  confirmSelectBtn.disabled = !(selectedCompetitorsSet.size >= minSelect && selectedCompetitorsSet.size <= maxSelect);
}

confirmSelectBtn.addEventListener('click', () => {
  if(selectingRoundIndex === null) return;
  const roundData = roundsData[selectingRoundIndex];
  roundData.passedIds = new Set(selectedCompetitorsSet);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï popupSelect ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á selected ‡∏î‡πâ‡∏ß‡∏¢
  competitorsSelectContainer.querySelectorAll('.competitor').forEach(div => {
    const id = div.dataset.id;
    if(roundData.passedIds.has(id)){
      div.classList.add('selected');
    } else {
      div.classList.remove('selected');
    }
  });

  console.log('Confirmed selected IDs:', [...roundData.passedIds]);

  popupSelect.style.display = 'none';

  updateMainSelectedBorder(selectingRoundIndex);

  const allSelected = roundsData.every(r => r.passedIds && r.passedIds.size > 0);
  btnNextRound.style.display = allSelected ? 'inline-block' : 'none';
});

function updateMainSelectedBorder(roundIndex){
  const roundBlock = roundsWrapper.querySelector(`.round-block[data-round-index="${roundIndex}"]`);
  if(!roundBlock) return;

  roundBlock.querySelectorAll('.car-id').forEach(div => {
    div.classList.remove('selected');
  });

  const passedIdsSet = new Set([...roundsData[roundIndex].passedIds].map(id => id.toString())); // üí° cast ‡πÄ‡∏õ‡πá‡∏ô string

  roundBlock.querySelectorAll('.car-id').forEach(div => {
    const carId = div.textContent.trim();
    if(passedIdsSet.has(carId)) {
      div.classList.add('selected'); // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    }
  });
}


closePopupSelectBtn.addEventListener('click', () => {
  popupSelect.style.display = 'none';
});

btnNextRound.addEventListener('click', () => {
  let nextRoundCompetitors = [];
  roundsData.forEach(({passedIds}) => {
    passedIds.forEach(id => {
      const found = allParticipants.find(p => p.id === id);
      if(found) nextRoundCompetitors.push(found);
    });
  });

  if(nextRoundCompetitors.length === 0){
    alert('Please select qualifiers first.');
    return;
  }

  roundsData = [];
  currentRoundIndex = 0;
  roundsWrapper.innerHTML = '';
  startBtn.style.display = 'none';
  roundTitle.textContent = 'NEXT ROUND';
  popup.style.display = 'flex';

  (async () => {
    const groupedRounds = groupCars(nextRoundCompetitors);
    const roundsCount = groupedRounds.length;

    for(let round=1; round<=roundsCount; round++){
      popupTitle.innerHTML = `ROUND <span class="round-number-popup">${round}</span>`;
      competitorsContainer.innerHTML = '';
      const currentGroup = groupedRounds[round - 1];

      const laneDivs = lanesLabels.children;
      for(let i=0; i<3; i++){
        laneDivs[i].style.display = i < currentGroup.length ? 'flex' : 'none';
      }

      for(let lane=0; lane<currentGroup.length; lane++){
        competitorsContainer.appendChild(createEmptyCompetitorDiv());
      }

      const winners = [];
      for(let lane=0; lane<currentGroup.length; lane++){
        const containerDiv = competitorsContainer.children[lane];
        await shuffleAnimation(lane, containerDiv, currentGroup);
        const winner = currentGroup[lane];
        winners.push(winner);
        containerDiv.querySelector('img').src = winner.image;
        containerDiv.querySelector('.name').textContent = winner.nickname;
        containerDiv.querySelector('.car-number').textContent = winner.id;
        await delay(400);
      }
      roundsData.push({round, winners, passedIds: new Set()});
      addRoundResult(round, winners);
      await delay(1000);
    }
    popup.style.display = 'none';
    roundTitle.textContent = "LET'S & GO INTO THE NEXT ROUND !";
    roundsWrapper.querySelectorAll('.round-block').forEach((block, i) => {
      block.addEventListener('click', () => openSelectPopup(i));
    });
    btnNextRound.style.display = 'none';
  })();
});

startBtn.addEventListener('click', async () => {
  if(allParticipants.length === 0) {
    alert('No participants loaded.');
    return;
  }
  await runAllRoundsShuffle();
});

async function init() {
  allParticipants = await loadParticipants();
  startBtn.disabled = false;
}

init();
</script>
</body>
</html>
